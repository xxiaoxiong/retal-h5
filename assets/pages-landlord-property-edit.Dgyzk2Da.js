import{d as e,r as l,H as a,I as s,o as t,c as i,w as o,a as r,s as u,h as n,A as c,J as d,i as p,e as f,f as m,g as _,t as g,K as v,L as h,M as b,j as y,F as V,k as w,G as k,q as x,m as W,y as U,N as j,O as I,P as O,Q as C}from"./index-BWYHzEly.js";import{a as $,g as A,u as P,p as F,b as q}from"./request.DW5hqJBG.js";import{_ as E}from"./_plugin-vue_export-helper.BCo6x5W8.js";const L=E(e({__name:"property-edit",setup(e){const E=l(null),L=a((()=>!!E.value)),D=s({title:"",description:"",address:"",city:"",district:"",price_per_month:0,area_sqm:0,bedrooms:1,bathrooms:1,property_type:"",amenities:[],images:[],status:"available",is_published:!1}),R=["公寓","别墅","独栋","联排","商铺","办公室","其他"],T=l(0),G=[{value:"available",label:"可租"},{value:"rented",label:"已租"},{value:"unavailable",label:"暂不可租"}],H=l(0),J=[{value:"wifi",label:"WiFi"},{value:"parking",label:"停车位"},{value:"ac",label:"空调"},{value:"heat",label:"暖气"},{value:"washer",label:"洗衣机"},{value:"kitchen",label:"厨房"},{value:"tv",label:"电视"},{value:"elevator",label:"电梯"},{value:"refrigerator",label:"冰箱"},{value:"microwave",label:"微波炉"},{value:"balcony",label:"阳台"},{value:"furniture",label:"家具齐全"}],K=e=>{if(!e)return"";const l=G.find((l=>l.value===e));return l?l.label:""},M=e=>{const l=e.detail.value;D.property_type=R[l],T.value=l},N=e=>{const l=e.detail.value;D.status=G[l].value,H.value=l},Q=()=>{var e;D.images||(D.images=[]),L.value?j({count:9-((null==(e=D.images)?void 0:e.length)||0),success:async e=>{if(E.value){u({title:"上传中..."});try{const a=Array.isArray(e.tempFilePaths)?e.tempFilePaths:[e.tempFilePaths];let s=0;for(const e of a)try{console.log(`尝试上传图片，房源ID: ${E.value}`);const l=await P(`/properties/${E.value}/images`,e,{},"images");if(console.log("上传结果:",l),l&&l.success)if(l.image_urls&&Array.isArray(l.image_urls)&&l.image_urls.length>0)for(const e of l.image_urls)e&&"string"==typeof e&&(D.images||(D.images=[]),D.images.push(e),s++);else if(l.url||l.data&&l.data.url){let e=l.url||l.data&&l.data.url||"";if(e){if(e.startsWith("/")&&!e.startsWith("//")){e=`${"http://localhost:3000"}${e}`}D.images||(D.images=[]),D.images.push(e),s++}}}catch(l){console.error("单张图片上传失败:",l)}n(),r(s>0?{title:`成功上传${s}张图片`,icon:"success",duration:2e3}:{title:"上传失败，请稍后重试",icon:"none",duration:2e3})}catch(a){n(),console.error("上传图片失败:",a),r({title:"上传失败，请稍后重试",icon:"none",duration:2e3})}}else r({title:"请先保存房源信息后再上传图片",icon:"none"})}}):r({title:"请先保存房源信息后再上传图片",icon:"none",duration:2e3})},z=e=>!!e&&(e.startsWith("blob:")||e.startsWith("file:")||e.startsWith("tmp")||e.includes("wxfile:")||e.includes("tmp_file")),B=async()=>{if(D.title)if(D.address&&D.city&&D.district)if(!D.price_per_month||D.price_per_month<=0)r({title:"请输入有效的租金金额",icon:"none"});else try{u({title:"保存中..."});const e={...D};if(e.images&&e.images.length>0){if(e.images.some((e=>"string"==typeof e&&(e.startsWith("blob:")||e.startsWith("file:")||e.startsWith("tmp")||e.includes("wxfile:")||e.includes("tmp_file"))))){const l=e.images.filter((e=>"string"==typeof e&&!(e.startsWith("blob:")||e.startsWith("file:")||e.startsWith("tmp")||e.includes("wxfile:")||e.includes("tmp_file"))));e.images=l,L.value&&D.images&&D.images.length!==l.length&&setTimeout((()=>{r({title:"本地图片未上传，请等待后端实现",icon:"none",duration:2e3})}),1500)}}let l;l=L.value?await F(`/properties/${E.value}`,e):await q("/properties",e),n(),l&&l.success?(r({title:"保存成功",icon:"success"}),S()):r({title:"保存失败",icon:"none"})}catch(e){n(),console.error("保存房源失败:",e),r({title:"保存失败，请重试",icon:"none"})}else r({title:"请填写完整地址信息",icon:"none"});else r({title:"请输入房源标题",icon:"none"})},S=()=>{const e=I(),l=e.length>1?e[e.length-2]:null;l&&l.route&&l.route.includes("properties")?d({delta:1,success:()=>{O("refreshProperties")}}):C({url:"/pages/landlord/properties",success:()=>{}})};return t((()=>{const e=$();e.id&&(E.value=e.id,(async()=>{if(E.value)try{u({title:"加载中..."});let l=`/properties/${E.value}`;try{const e=await A(l);if(n(),!e)throw new Error("API返回空数据");if(e&&e.success&&e.property){Object.assign(D,e.property);const l=D.property_type||"";return T.value=R.indexOf(l),void(H.value=G.findIndex((e=>e.value===D.status)))}if(e&&!e.success)throw new Error(e.message||"获取房源信息失败");if(e&&!e.property&&(e.id||e._id)){Object.assign(D,e);const l=D.property_type||"";return T.value=R.indexOf(l),void(H.value=G.findIndex((e=>e.value===D.status)))}if("object"==typeof e&&null!==e){Object.assign(D,e);const l=D.property_type||"";return T.value=R.indexOf(l),void(H.value=G.findIndex((e=>e.value===D.status)))}throw new Error("未能识别的API响应格式")}catch(e){l=`/api/properties/${E.value}`;const a=await A(l);if(!a)throw new Error("备用URL返回空数据");{if(a.success&&a.property)Object.assign(D,a.property);else{if(!a.id&&!a._id)throw new Error("备用URL返回的数据格式不正确");Object.assign(D,a)}const e=D.property_type||"";T.value=R.indexOf(e),H.value=G.findIndex((e=>e.value===D.status))}}}catch(e){n(),console.error("获取房源详情失败:",e),r({title:"获取房源信息失败",icon:"none"}),c({title:"加载失败",content:"无法获取房源数据，是否返回列表?",success:e=>{e.confirm&&d()}})}else r({title:"缺少房源ID",icon:"none"})})())})),(e,l)=>{const a=p,s=v,t=h,r=b,u=W,n=U;return f(),i(a,{class:"property-edit-page"},{default:o((()=>[m(a,{class:"header"},{default:o((()=>[m(a,{class:"title"},{default:o((()=>[_(g(L.value?"编辑房源":"新增房源"),1)])),_:1})])),_:1}),m(a,{class:"form-container"},{default:o((()=>[m(a,{class:"form-group"},{default:o((()=>[m(a,{class:"label"},{default:o((()=>[_("标题")])),_:1}),m(s,{modelValue:D.title,"onUpdate:modelValue":l[0]||(l[0]=e=>D.title=e),placeholder:"请输入房源标题"},null,8,["modelValue"])])),_:1}),m(a,{class:"form-group"},{default:o((()=>[m(a,{class:"label"},{default:o((()=>[_("描述")])),_:1}),m(t,{modelValue:D.description,"onUpdate:modelValue":l[1]||(l[1]=e=>D.description=e),placeholder:"请输入房源描述"},null,8,["modelValue"])])),_:1}),m(a,{class:"form-row"},{default:o((()=>[m(a,{class:"form-group half"},{default:o((()=>[m(a,{class:"label"},{default:o((()=>[_("城市")])),_:1}),m(s,{modelValue:D.city,"onUpdate:modelValue":l[2]||(l[2]=e=>D.city=e),placeholder:"城市"},null,8,["modelValue"])])),_:1}),m(a,{class:"form-group half"},{default:o((()=>[m(a,{class:"label"},{default:o((()=>[_("区域")])),_:1}),m(s,{modelValue:D.district,"onUpdate:modelValue":l[3]||(l[3]=e=>D.district=e),placeholder:"区域"},null,8,["modelValue"])])),_:1})])),_:1}),m(a,{class:"form-group"},{default:o((()=>[m(a,{class:"label"},{default:o((()=>[_("详细地址")])),_:1}),m(s,{modelValue:D.address,"onUpdate:modelValue":l[4]||(l[4]=e=>D.address=e),placeholder:"请输入详细地址"},null,8,["modelValue"])])),_:1}),m(a,{class:"form-row"},{default:o((()=>[m(a,{class:"form-group half"},{default:o((()=>[m(a,{class:"label"},{default:o((()=>[_("月租金(元)")])),_:1}),m(s,{modelValue:D.price_per_month,"onUpdate:modelValue":l[5]||(l[5]=e=>D.price_per_month=e),type:"number",placeholder:"月租金"},null,8,["modelValue"])])),_:1}),m(a,{class:"form-group half"},{default:o((()=>[m(a,{class:"label"},{default:o((()=>[_("面积(平方米)")])),_:1}),m(s,{modelValue:D.area_sqm,"onUpdate:modelValue":l[6]||(l[6]=e=>D.area_sqm=e),type:"number",placeholder:"面积"},null,8,["modelValue"])])),_:1})])),_:1}),m(a,{class:"form-row"},{default:o((()=>[m(a,{class:"form-group half"},{default:o((()=>[m(a,{class:"label"},{default:o((()=>[_("卧室数量")])),_:1}),m(s,{modelValue:D.bedrooms,"onUpdate:modelValue":l[7]||(l[7]=e=>D.bedrooms=e),type:"number",placeholder:"卧室数量"},null,8,["modelValue"])])),_:1}),m(a,{class:"form-group half"},{default:o((()=>[m(a,{class:"label"},{default:o((()=>[_("卫生间数量")])),_:1}),m(s,{modelValue:D.bathrooms,"onUpdate:modelValue":l[8]||(l[8]=e=>D.bathrooms=e),type:"number",placeholder:"卫生间数量"},null,8,["modelValue"])])),_:1})])),_:1}),m(a,{class:"form-group"},{default:o((()=>[m(a,{class:"label"},{default:o((()=>[_("房屋类型")])),_:1}),m(r,{onChange:M,value:T.value,range:R},{default:o((()=>[m(a,{class:"picker-value"},{default:o((()=>[_(g(D.property_type||"请选择房屋类型"),1)])),_:1})])),_:1},8,["value"])])),_:1}),m(a,{class:"form-group"},{default:o((()=>[m(a,{class:"label"},{default:o((()=>[_("租赁状态")])),_:1}),m(r,{onChange:N,value:H.value,range:G,"range-key":"label"},{default:o((()=>[m(a,{class:"picker-value"},{default:o((()=>[_(g(K(D.status)||"请选择租赁状态"),1)])),_:1})])),_:1},8,["value"])])),_:1}),m(a,{class:"form-group"},{default:o((()=>[m(a,{class:"label"},{default:o((()=>[_("房屋设施")])),_:1}),m(a,{class:"amenities-list"},{default:o((()=>[(f(),y(V,null,w(J,((e,l)=>m(a,{key:l,class:k(["amenity-item",{selected:D.amenities&&D.amenities.includes(e.value)}]),onClick:l=>{return a=e.value,D.amenities||(D.amenities=[]),void(D.amenities.includes(a)?D.amenities=D.amenities.filter((e=>e!==a)):D.amenities.push(a));var a}},{default:o((()=>[_(g(e.label),1)])),_:2},1032,["class","onClick"]))),64))])),_:1})])),_:1}),m(a,{class:"form-group"},{default:o((()=>[m(a,{class:"label"},{default:o((()=>[_("房源图片")])),_:1}),m(a,{class:"image-uploader"},{default:o((()=>[(f(!0),y(V,null,w(D.images||[],((e,l)=>(f(),i(a,{key:l,class:k(["image-item",{"temp-image":z(e)}])},{default:o((()=>[m(u,{src:e,mode:"aspectFill"},null,8,["src"]),m(a,{class:"delete-btn",onClick:e=>(e=>{D.images&&D.images.splice(e,1)})(l)},{default:o((()=>[_("×")])),_:2},1032,["onClick"]),z(e)?(f(),i(a,{key:0,class:"temp-badge"},{default:o((()=>[_("临时")])),_:1})):x("",!0)])),_:2},1032,["class"])))),128)),m(a,{class:"add-image-btn",onClick:Q},{default:o((()=>[m(a,{class:"plus"},{default:o((()=>[_("+")])),_:1}),m(a,{class:"text"},{default:o((()=>[_("添加图片")])),_:1})])),_:1})])),_:1}),L.value?(f(),i(a,{key:1,class:"image-tips"},{default:o((()=>[_(" 最多上传9张图片 ")])),_:1})):(f(),i(a,{key:0,class:"image-tips"},{default:o((()=>[_(" 创建房源后可上传图片（最多9张） ")])),_:1}))])),_:1}),m(a,{class:"action-buttons"},{default:o((()=>[m(n,{onClick:l[9]||(l[9]=()=>(d({delta:1}),void setTimeout((()=>{1===I().length&&C({url:"/pages/landlord/properties"})}),100))),class:"cancel-btn"},{default:o((()=>[_("取消")])),_:1}),m(n,{onClick:B,class:"save-btn"},{default:o((()=>[_("保存")])),_:1})])),_:1})])),_:1})])),_:1})}}}),[["__scopeId","data-v-4bc22f82"]]);export{L as default};

import{d as e,r as a,o as t,E as l,R as s,c as n,w as o,a as u,T as i,i as r,b as c,e as d,f as p,g as v,j as f,F as m,k as g,n as _,G as y,t as h,m as k,p as b,q as $,y as w,U as S,A,s as C,h as x}from"./index-BWYHzEly.js";import{g as z,p as j}from"./request.DW5hqJBG.js";import{_ as F}from"./_plugin-vue_export-helper.BCo6x5W8.js";const I=F(e({__name:"appointments",setup(e){const F=a([]),I=a(!0),E=a(!1),U=a(!1),q=a(!0),D=a(1),M=[{label:"全部",value:"all"},{label:"待确认",value:"pending"},{label:"已确认",value:"confirmed"},{label:"已完成",value:"completed"},{label:"已取消",value:"cancelled"}],R=a(M[0]),G=async(e=1,a="all",t=!1)=>{t?U.value=!0:1===e?(I.value=!0,F.value=[]):E.value=!0;const l="all"===a?void 0:a;console.log(`Fetching appointments: page=${e}, status=${l}`);try{const a={page:e,limit:10};l&&(a.status=l);const t=await z("/appointments",a);if(console.log("API response:",t),t&&Array.isArray(t)){const a=t;F.value=1===e?a:[...F.value,...a],q.value=10===a.length}else if(t&&Array.isArray(t.appointments)){const a=t.appointments;F.value=1===e?a:[...F.value,...a],q.value=t.total?F.value.length<t.total:10===a.length}else if(t&&t.data&&Array.isArray(t.data)){const a=t.data;F.value=1===e?a:[...F.value,...a],q.value=t.total?F.value.length<t.total:10===a.length}else console.error("Invalid response format:",t),u({title:"数据格式错误",icon:"none"})}catch(s){console.error("Error fetching appointments:",s),u({title:"加载失败，请重试",icon:"none"})}finally{t?(U.value=!1,i()):1===e?I.value=!1:E.value=!1}},H=()=>{D.value=1,G(1,R.value.value,!0)},P=()=>{q.value&&!E.value&&(D.value++,G(D.value,R.value.value))},T=async(e,a,t)=>{console.log(`Updating appointment ${e} to status ${a}`),A({title:"确认操作",content:`确定要${t}吗？`,success:async t=>{if(t.confirm){C({title:"处理中..."});try{const t=await j(`/appointments/${e}/status`,{status:a});if(console.log("Update status response:",t),t&&(t.success||t.id)){u({title:"操作成功",icon:"success"});const t=F.value.findIndex((a=>a.id===e));-1!==t&&(F.value[t].status=a,"all"!==R.value.value&&R.value.value!==a&&F.value.splice(t,1))}else u({title:"操作失败",icon:"error"})}catch(l){console.error("Error updating appointment status:",l),u({title:"操作失败",icon:"error"})}finally{x()}}}})},Y=e=>{switch(e){case"pending":return"待确认";case"confirmed":return"已确认";case"cancelled":return"已取消";case"completed":return"已完成";default:return"未知"}},B=e=>{const a=new Date(e);return`${a.getFullYear()}-${(a.getMonth()+1).toString().padStart(2,"0")}-${a.getDate().toString().padStart(2,"0")} ${a.getHours().toString().padStart(2,"0")}:${a.getMinutes().toString().padStart(2,"0")}`};return t((()=>{G()})),l((()=>{P()})),s((()=>{H()})),(e,a)=>{const t=r,l=_,s=k,u=c("uni-icons"),i=w,A=b;return d(),n(t,{class:"appointments-list-page"},{default:o((()=>[p(t,{class:"header"},{default:o((()=>[p(t,{class:"title"},{default:o((()=>[v("预约管理")])),_:1}),p(t,{class:"filter-tabs"},{default:o((()=>[(d(),f(m,null,g(M,(e=>p(l,{key:e.value,class:y({active:R.value.value===e.value}),onClick:a=>(e=>{R.value.value!==e.value&&(R.value=e,D.value=1,G(D.value,R.value.value))})(e)},{default:o((()=>[v(h(e.label),1)])),_:2},1032,["class","onClick"]))),64))])),_:1})])),_:1}),I.value&&0===F.value.length?(d(),n(t,{key:0,class:"loading-placeholder"},{default:o((()=>[p(t,{class:"loading-spinner"}),p(l,{class:"loading-text"},{default:o((()=>[v("加载中...")])),_:1})])),_:1})):0===F.value.length?(d(),n(t,{key:1,class:"empty-placeholder"},{default:o((()=>[p(s,{src:"./static/empty-appointments.png",mode:"aspectFit",class:"empty-image"}),p(l,{class:"empty-text"},{default:o((()=>[v("暂无"+h(R.value.label)+"预约",1)])),_:1})])),_:1})):(d(),n(A,{key:2,class:"appointments-list","scroll-y":"","refresher-enabled":!0,"refresher-triggered":U.value,onRefresherrefresh:H,onScrolltolower:P},{default:o((()=>[(d(!0),f(m,null,g(F.value,(e=>(d(),n(t,{key:e.id,class:"appointment-item"},{default:o((()=>[p(t,{class:"item-header"},{default:o((()=>[p(t,{class:"property-title"},{default:o((()=>[v(h(e.property.title),1)])),_:2},1024),p(t,{class:y(["status-tag",`status-${e.status}`])},{default:o((()=>[v(h(Y(e.status)),1)])),_:2},1032,["class"])])),_:2},1024),p(t,{class:"item-body"},{default:o((()=>[p(t,{class:"info-row"},{default:o((()=>[p(u,{type:"calendar",size:"16",color:"#999"}),p(l,{class:"label"},{default:o((()=>[v("预约时间:")])),_:1}),p(l,{class:"value"},{default:o((()=>[v(h(B(e.appointment_time)),1)])),_:2},1024)])),_:2},1024),p(t,{class:"info-row"},{default:o((()=>[p(u,{type:"person",size:"16",color:"#999"}),p(l,{class:"label"},{default:o((()=>[v("租客:")])),_:1}),p(l,{class:"value"},{default:o((()=>[v(h(e.tenant.nickname||"匿名用户")+" "+h(e.tenant.phone_number?`(${e.tenant.phone_number})`:""),1)])),_:2},1024)])),_:2},1024),e.tenant_notes?(d(),n(t,{key:0,class:"info-row"},{default:o((()=>[p(u,{type:"chat",size:"16",color:"#999"}),p(l,{class:"label"},{default:o((()=>[v("租客备注:")])),_:1}),p(l,{class:"value"},{default:o((()=>[v(h(e.tenant_notes),1)])),_:2},1024)])),_:2},1024)):$("",!0)])),_:2},1024),"pending"===e.status?(d(),n(t,{key:0,class:"item-actions"},{default:o((()=>[p(i,{size:"mini",plain:"",onClick:S((a=>T(e.id,"cancelled","取消预约")),["stop"])},{default:o((()=>[v("取消")])),_:2},1032,["onClick"]),p(i,{size:"mini",onClick:S((a=>T(e.id,"confirmed","确认预约")),["stop"])},{default:o((()=>[v("确认")])),_:2},1032,["onClick"])])),_:2},1024)):"confirmed"===e.status?(d(),n(t,{key:1,class:"item-actions"},{default:o((()=>[p(i,{size:"mini",onClick:S((a=>T(e.id,"completed","完成看房")),["stop"])},{default:o((()=>[v("完成看房")])),_:2},1032,["onClick"])])),_:2},1024)):$("",!0)])),_:2},1024)))),128)),E.value?(d(),n(t,{key:0,class:"loading-more"},{default:o((()=>[p(t,{class:"loading-dots"},{default:o((()=>[p(t,{class:"dot"}),p(t,{class:"dot"}),p(t,{class:"dot"})])),_:1}),p(l,null,{default:o((()=>[v("加载更多预约...")])),_:1})])),_:1})):$("",!0),!q.value&&F.value.length>0?(d(),n(t,{key:1,class:"no-more"},{default:o((()=>[v("—— 已经到底啦 ——")])),_:1})):$("",!0)])),_:1},8,["refresher-triggered"]))])),_:1})}}}),[["__scopeId","data-v-d17a11df"]]);export{I as default};

import{d as e,r as a,I as l,o as t,z as s,A as i,u as n,J as o,c as r,w as c,i as u,b as d,e as f,f as m,q as p,n as v,g,t as y,y as _,j as b,F as k,k as h,m as w,K as C,a as A,s as T,h as j,N as z,a1 as E}from"./index-BWYHzEly.js";import{g as D,p as V,b as x,d as F,u as $}from"./request.DW5hqJBG.js";import{_ as S}from"./_plugin-vue_export-helper.BCo6x5W8.js";const q=S(e({__name:"banner-management",setup(e){const S=a(!1),q=a([]),I=a(!1),M=a(-1),P=a(null),U=a(!1),W=a(""),J=l({title:"",image:"",link:""});t((()=>{K()}));const K=async()=>{S.value=!0,W.value="";if(s("token"))try{let e;e=await D("/users/me"),console.log("用户信息:",e),e&&("admin"===e.role||!0===e.isAdmin||"landlord"===e.role||e.roles&&(e.roles.includes("admin")||e.roles.includes("landlord"))),U.value=!0,O()}catch(e){console.error("获取用户信息失败:",e),U.value=!0,O()}finally{S.value=!1}else N("未登录，请先登录")},N=e=>{W.value=e,U.value=!1,S.value=!1,i({title:"访问受限",content:e,showCancel:!0,cancelText:"返回",confirmText:"去登录",success:e=>{e.confirm?n({url:"/pages/landlord/login"}):o()}}),O()},O=async()=>{S.value=!0;try{let e;if(e=await D("/banners"),console.log("轮播图数据响应:",e),e){let a=[];if(Array.isArray(e))a=e;else if(e.success&&Array.isArray(e.data))a=e.data;else if(e.banners&&Array.isArray(e.banners))a=e.banners;else if(e.items&&Array.isArray(e.items))a=e.items;else if(e.list&&Array.isArray(e.list))a=e.list;else if(e.data&&"object"==typeof e.data&&!Array.isArray(e.data)){const l=["banners","items","list","records"];for(const t of l)if(e.data[t]&&Array.isArray(e.data[t])){a=e.data[t];break}}const l=new Set;a=a.filter((e=>!e.id||!l.has(e.id)&&(l.add(e.id),!0))),a=a.map((e=>({...e,image:Y(e.image)}))),q.value=a}}catch(e){console.error("获取轮播图数据异常:",e)}finally{S.value=!1}},B=()=>{U.value?(G(),I.value=!1,M.value=-1,setTimeout((()=>{P.value.open()}),100)):A({title:"没有操作权限",icon:"none"})},G=()=>{Object.keys(J).forEach((e=>{J[e]=""})),J.title="",J.image="",J.link="",setTimeout((()=>{var e;if(P.value){const a=null==(e=P.value.$el)?void 0:e.querySelector(".form-content");a&&(a.style.opacity="0.99",setTimeout((()=>{a.style.opacity="1"}),10))}}),50)},H=()=>{P.value.close()},L=async()=>{if(!J.title)return void A({title:"请输入标题",icon:"none"});if(!J.image)return void A({title:"请上传图片",icon:"none"});const e={title:J.title,image:J.image,link:J.link};if(I.value&&M.value>=0){const l=q.value[M.value].id;l&&(e.id=l);try{if(T({title:"保存中..."}),l){let a;if(a=await V(`/banners/${l}`,e),a&&"object"==typeof a&&"error"in a&&"permission_denied"===a.error)throw new Error("没有足够的权限执行此操作")}else q.value[M.value]={...e};j(),A({title:"保存成功",icon:"success"}),H(),q.value[M.value]={...q.value[M.value],...e,image:Y(e.image)},l&&setTimeout((()=>{O()}),300)}catch(a){j()}}else try{let a;if(T({title:"添加中..."}),a=await x("/banners",e),a&&"object"==typeof a&&"error"in a&&"permission_denied"===a.error)throw new Error("没有足够的权限执行此操作");const l=a&&a.data?a.data:{...e,id:String(Date.now())};l.image=Y(l.image),j(),A({title:"添加成功",icon:"success"}),H(),setTimeout((()=>{O()}),300)}catch(a){if(j(),a.message&&a.message.includes("权限"))i({title:"权限错误",content:"您没有足够的权限执行此操作",showCancel:!1}),U.value=!1;else{console.error("添加轮播图失败:",a);const l={...e,id:String(Date.now())};l.image=Y(l.image),q.value.some((e=>e.id===l.id))||q.value.push(l),A({title:"已添加到本地列表",icon:"none"}),H()}}},Q=async e=>{if(!U.value)return void A({title:"没有删除权限",icon:"none"});const a=q.value[e].id;try{if(T({title:"删除中..."}),a){let e;if(e=await F(`/banners/${a}`),e&&"object"==typeof e&&"error"in e&&"permission_denied"===e.error)throw new Error("没有足够的权限执行此操作")}q.value.splice(e,1),j(),A({title:"删除成功",icon:"success"}),setTimeout((()=>{O()}),300)}catch(l){j(),l.message&&l.message.includes("权限")?(i({title:"权限错误",content:"您没有足够的权限执行此操作",showCancel:!1}),U.value=!1,O()):(console.error("删除轮播图失败:",l),q.value.splice(e,1),A({title:"已从本地列表移除",icon:"none"}),setTimeout((()=>{O()}),300))}},R=()=>{U.value?z({count:1,success:async e=>{const a=e.tempFilePaths[0];T({title:"上传中..."});try{let e;if(e=await $("/upload/image",a),e&&"object"==typeof e&&"error"in e&&"permission_denied"===e.error)throw new Error("没有足够的权限执行此操作");if(e&&e.success&&e.url)J.image=e.url,j(),A({title:"上传成功",icon:"success"});else{if(!(e&&e.image_urls&&e.image_urls.length>0))throw new Error("上传失败");J.image=e.image_urls[0],j(),A({title:"上传成功",icon:"success"})}}catch(l){j(),l.message&&l.message.includes("权限")?(i({title:"权限错误",content:"您没有足够的权限执行此操作",showCancel:!1}),U.value=!1):(console.error("上传图片失败:",l),J.image=a,A({title:"使用本地图片预览",icon:"none"}))}}}):A({title:"没有上传权限",icon:"none"})},X=async()=>{if(U.value)try{const e=q.value.map((e=>e.id)).filter((e=>e));if(e.length>0){let a;if(a=await x("/banners/reorder",{order:e}),a&&"object"==typeof a&&"error"in a&&"permission_denied"===a.error)throw new Error("没有足够的权限执行此操作");A({title:"排序已保存",icon:"success"}),setTimeout((()=>{O()}),300)}}catch(e){console.error("保存轮播图排序失败:",e),e.message&&e.message.includes("权限")?(i({title:"权限错误",content:"您没有足够的权限执行此操作",showCancel:!1}),U.value=!1,O()):(A({title:"排序保存失败",icon:"none"}),setTimeout((()=>{O()}),300))}else A({title:"没有排序权限",icon:"none"})},Y=e=>{if(!e)return e;let a=e;if(e.includes("?")){const[l,t]=e.split("?"),s=t.split("&").filter((e=>!e.startsWith("_t=")));a=l+(s.length>0?"?"+s.join("&"):"")}const l=a.includes("?");return a+(l?"&":"?")+`_t=${Date.now()}${Math.floor(1e4*Math.random())}`},Z=()=>{U.value?(J.image="",A({title:"图片已移除",icon:"success"})):A({title:"没有移除权限",icon:"none"})};return(e,a)=>{const l=v,t=d("uni-icons"),s=u,n=_,o=w,z=C,D=d("uni-popup");return f(),r(s,{class:"banner-management-page"},{default:c((()=>[m(s,{class:"page-header"},{default:c((()=>[m(s,{class:"header-content"},{default:c((()=>[m(s,{class:"title-section"},{default:c((()=>[m(l,{class:"page-title"},{default:c((()=>[g("轮播图管理")])),_:1}),U.value||S.value?p("",!0):(f(),r(s,{key:0,class:"permission-notice"},{default:c((()=>[m(t,{type:"info-filled",size:"14",color:"#faad14"}),m(l,null,{default:c((()=>[g("只读模式：您没有管理员权限")])),_:1})])),_:1}))])),_:1})])),_:1})])),_:1}),S.value?(f(),r(s,{key:0,class:"loading-container"},{default:c((()=>[m(t,{type:"spinner-cycle",size:"30",color:"#2196f3"}),m(l,null,{default:c((()=>[g("加载中...")])),_:1})])),_:1})):p("",!0),W.value&&!S.value?(f(),r(s,{key:1,class:"error-container"},{default:c((()=>[m(l,{class:"error-message"},{default:c((()=>[g(y(W.value),1)])),_:1}),m(n,{onClick:K,class:"retry-button"},{default:c((()=>[g("重试")])),_:1})])),_:1})):p("",!0),S.value?p("",!0):(f(),r(s,{key:2,class:"banner-list-container"},{default:c((()=>[0===q.value.length?(f(),r(s,{key:0,class:"empty-state"},{default:c((()=>[m(t,{type:"image",size:"50",color:"#ccc"}),m(l,null,{default:c((()=>[g("暂无轮播图数据")])),_:1}),U.value?(f(),r(s,{key:0,class:"empty-action",onClick:B},{default:c((()=>[m(l,null,{default:c((()=>[g("点击添加轮播图")])),_:1})])),_:1})):p("",!0)])),_:1})):p("",!0),(f(!0),b(k,null,h(q.value,((e,a)=>(f(),r(s,{class:"banner-item",key:e.id||"banner_"+a+"_"+Date.now()},{default:c((()=>[m(s,{class:"banner-preview"},{default:c((()=>[(f(),r(o,{src:e.image,mode:"aspectFill",class:"banner-image",onClick:a=>(e=>{let a=e;if(e.includes("?")){const[l,t]=e.split("?"),s=t.split("&").filter((e=>!e.startsWith("_t=")));a=l+(s.length>0?"?"+s.join("&"):"")}E({urls:[a],current:a})})(e.image),key:"img_"+(e.id||a)+"_"+Date.now()},null,8,["src","onClick"])),m(s,{class:"banner-info"},{default:c((()=>[m(l,{class:"banner-title"},{default:c((()=>[g(y(e.title),1)])),_:2},1024),m(l,{class:"banner-order"},{default:c((()=>[g("顺序: "+y(a+1),1)])),_:2},1024),e.link?(f(),r(l,{key:0,class:"banner-link"},{default:c((()=>[g(y(e.link),1)])),_:2},1024)):p("",!0)])),_:2},1024)])),_:2},1024),U.value?(f(),r(s,{key:0,class:"banner-actions"},{default:c((()=>[m(n,{class:"action-btn edit-btn",onClick:e=>(e=>{if(!U.value)return void A({title:"没有操作权限",icon:"none"});const a=q.value[e];G(),J.title=a.title,J.image=a.image?a.image:"",J.link=a.link||"",I.value=!0,M.value=e,setTimeout((()=>{P.value.open()}),50)})(a)},{default:c((()=>[m(t,{type:"compose",size:"14",color:"#409eff"}),m(l,null,{default:c((()=>[g("编辑")])),_:1})])),_:2},1032,["onClick"]),m(n,{class:"action-btn delete-btn",onClick:e=>(e=>{U.value?i({title:"确认删除",content:"确定要删除这个轮播图吗？",success:async a=>{a.confirm&&Q(e)}}):A({title:"没有操作权限",icon:"none"})})(a)},{default:c((()=>[m(t,{type:"trash",size:"14",color:"#f56c6c"}),m(l,null,{default:c((()=>[g("删除")])),_:1})])),_:2},1032,["onClick"]),a>0?(f(),r(n,{key:0,class:"action-btn order-btn",onClick:e=>(e=>{if(U.value){if(e>0){const a=q.value[e];q.value[e]=q.value[e-1],q.value[e-1]=a,q.value=q.value.map((e=>({...e,image:Y(e.image)}))),T({title:"排序中..."}),X(),setTimeout((()=>{j()}),500)}}else A({title:"没有操作权限",icon:"none"})})(a)},{default:c((()=>[m(t,{type:"arrow-up",size:"14",color:"#67c23a"}),m(l,null,{default:c((()=>[g("上移")])),_:1})])),_:2},1032,["onClick"])):p("",!0),a<q.value.length-1?(f(),r(n,{key:1,class:"action-btn order-btn",onClick:e=>(e=>{if(U.value){if(e<q.value.length-1){const a=q.value[e];q.value[e]=q.value[e+1],q.value[e+1]=a,q.value=q.value.map((e=>({...e,image:Y(e.image)}))),T({title:"排序中..."}),X(),setTimeout((()=>{j()}),500)}}else A({title:"没有操作权限",icon:"none"})})(a)},{default:c((()=>[m(t,{type:"arrow-down",size:"14",color:"#909399"}),m(l,null,{default:c((()=>[g("下移")])),_:1})])),_:2},1032,["onClick"])):p("",!0)])),_:2},1024)):p("",!0)])),_:2},1024)))),128))])),_:1})),m(D,{ref_key:"bannerFormPopup",ref:P,type:"bottom"},{default:c((()=>[m(s,{class:"form-popup"},{default:c((()=>[m(s,{class:"form-header"},{default:c((()=>[m(l,{class:"form-title"},{default:c((()=>[g(y(I.value?"编辑轮播图":"添加轮播图"),1)])),_:1}),m(s,{class:"form-close",onClick:H},{default:c((()=>[m(t,{type:"closeempty",size:"20",color:"#999"})])),_:1})])),_:1}),m(s,{class:"form-content"},{default:c((()=>[m(s,{class:"form-group"},{default:c((()=>[m(s,{class:"label"},{default:c((()=>[g("标题")])),_:1}),m(z,{modelValue:J.title,"onUpdate:modelValue":a[0]||(a[0]=e=>J.title=e),placeholder:"请输入标题",class:"input-field"},null,8,["modelValue"])])),_:1}),m(s,{class:"form-group"},{default:c((()=>[m(s,{class:"label"},{default:c((()=>[g("图片")])),_:1}),m(s,{class:"image-uploader"},{default:c((()=>[J.image?(f(),r(o,{src:J.image,mode:"aspectFill",class:"uploaded-image",key:J.image+"_"+Date.now()},null,8,["src"])):p("",!0),J.image?p("",!0):(f(),r(s,{key:1,class:"upload-button",onClick:R},{default:c((()=>[m(t,{type:"camera",size:"30",color:"#999"}),m(l,null,{default:c((()=>[g("上传图片")])),_:1})])),_:1})),J.image?(f(),r(s,{key:2,class:"image-actions"},{default:c((()=>[m(s,{class:"change-image-btn",onClick:R},{default:c((()=>[m(t,{type:"reload",size:"14",color:"#409eff"}),m(l,null,{default:c((()=>[g("更换图片")])),_:1})])),_:1}),m(s,{class:"remove-image-btn",onClick:Z},{default:c((()=>[m(t,{type:"trash",size:"14",color:"#f56c6c"}),m(l,null,{default:c((()=>[g("移除图片")])),_:1})])),_:1})])),_:1})):p("",!0)])),_:1})])),_:1}),m(s,{class:"form-group"},{default:c((()=>[m(s,{class:"label"},{default:c((()=>[g("链接（选填）")])),_:1}),m(z,{modelValue:J.link,"onUpdate:modelValue":a[1]||(a[1]=e=>J.link=e),placeholder:"点击轮播图跳转的链接，如：/pages/tenant/property-detail?id=123",class:"input-field"},null,8,["modelValue"])])),_:1}),m(n,{class:"submit-btn",onClick:L},{default:c((()=>[g("保存")])),_:1})])),_:1})])),_:1})])),_:1},512)])),_:1})}}}),[["__scopeId","data-v-aac751a7"]]);export{q as default};
